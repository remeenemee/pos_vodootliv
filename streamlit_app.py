import streamlit as st
import numpy as np
from docx import Document
from docx.shared import Pt, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH
import io

# "ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð° Ð¿Ñ€ÐµÐ´Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð° Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° Ð¿Ñ€Ð¸Ñ‚Ð¾ÐºÐ° Ð²Ð¾Ð´Ñ‹ Ð² ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½"
st.set_page_config(layout="wide")
st.title("ðŸ’§ Ð Ð°ÑÑ‡ÐµÑ‚ Ð¿Ñ€Ð¸Ñ‚Ð¾ÐºÐ° Ð²Ð¾Ð´Ñ‹ Ð² ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½")
st.markdown("ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¼ÐµÑ‚Ð¾Ð´Ð¸ÐºÐ¸ Ð¸Ð· Ñ€Ð°ÑÑ‡ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð° Ð¸ Ð¡ÐŸ 103.13330.2012")

# --- Ð’ÐºÐ»Ð°Ð´ÐºÐ¸ ---
tab1, tab2, tab3 = st.tabs(["Ð Ð°ÑÑ‡ÐµÑ‚", "ÐœÐµÑ‚Ð¾Ð´Ð¸ÐºÐ°", "Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð² Word"])

# --- Ð¥Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… ---
calc_data = {}

with tab1:
    st.header("ðŸ”§ Ð’Ð²Ð¾Ð´ Ð´Ð°Ð½Ð½Ñ‹Ñ… (Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐ¸ Ð¾Ñ‚ Ð¿Ð¾Ð²ÐµÑ€Ñ…Ð½Ð¾ÑÑ‚Ð¸ Ð·ÐµÐ¼Ð»Ð¸ = 0.00 Ð¼)")

    col1, col2 = st.columns(2)

    with col1:
        L = st.number_input("Ð”Ð»Ð¸Ð½Ð° ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½Ð° L, Ð¼", min_value=1.0, value=21.48)
        B = st.number_input("Ð¨Ð¸Ñ€Ð¸Ð½Ð° ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½Ð° B, Ð¼", min_value=1.0, value=29.2)
        depth = st.number_input("Ð“Ð»ÑƒÐ±Ð¸Ð½Ð° ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½Ð°, Ð¼", min_value=0.1, value=2.25)
        z_bottom = -depth  # Ð´Ð½Ð¾ ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½Ð°

    with col2:
        z_water_depth = st.number_input("Ð“Ð»ÑƒÐ±Ð¸Ð½Ð° Ð£Ð“Ð’ Ð¾Ñ‚ Ð¿Ð¾Ð²ÐµÑ€Ñ…Ð½Ð¾ÑÑ‚Ð¸, Ð¼", min_value=0.0, value=1.10)
        z_water = -z_water_depth  # Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐ° Ð£Ð“Ð’
        k = st.number_input("ÐšÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ k, Ð¼/ÑÑƒÑ‚", min_value=0.01, value=2.0)
        reserve = st.number_input("Ð—Ð°Ð¿Ð°Ñ Ð¿Ð¾Ð½Ð¸Ð¶ÐµÐ½Ð¸Ñ Ð½Ð¸Ð¶Ðµ Ð´Ð½Ð°, Ð¼", min_value=0.0, value=1.0)

    # --- Ð’Ñ‹Ð±Ð¾Ñ€ Ñ‚Ð¸Ð¿Ð° ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½Ð° ---
    st.subheader("Ð¢Ð¸Ð¿ ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½Ð°")
    type_option = st.radio(
        "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‚Ð¸Ð¿",
        ["ÐÐµÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¹", "Ð¡Ð¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¹"],
        horizontal=True
    )

    # --- ÐžÐ±Ñ‰Ð¸Ð¹ Ñ€Ð°ÑÑ‡ÐµÑ‚ Ð¿Ð¾Ð½Ð¸Ð¶ÐµÐ½Ð¸Ñ s ---
    s = depth + reserve - z_water_depth  # s = Ð³Ð»ÑƒÐ±Ð¸Ð½Ð° + Ð·Ð°Ð¿Ð°Ñ - Ð³Ð»ÑƒÐ±Ð¸Ð½Ð° Ð£Ð“Ð’
    st.info(f"ðŸ”¹ Ð“Ð»ÑƒÐ±Ð¸Ð½Ð° Ð¿Ð¾Ð½Ð¸Ð¶ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ½Ñ‚Ð¾Ð²Ñ‹Ñ… Ð²Ð¾Ð´: **s = {s:.2f} Ð¼**")

    # --- Ð Ð°ÑÑ‡ÐµÑ‚ Ð´Ð»Ñ ÐÐ•Ð¡ÐžÐ’Ð•Ð Ð¨Ð•ÐÐÐžÐ“Ðž ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½Ð° (Ð¿Ð¾ Ñ€Ð°ÑÑ‡ÐµÑ‚.pdf) ---
    if type_option == "ÐÐµÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¹":
        st.info("ðŸ”¹ ÐšÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½ Ð½ÐµÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¹ â€” Ð´Ð½Ð¾ Ð½Ðµ Ð´Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚ Ð´Ð¾ Ð²Ð¾Ð´Ð¾ÑƒÐ¿Ð¾Ñ€Ð½Ð¾Ð³Ð¾ ÑÐ»Ð¾Ñ")

        # 1. Ð’Ñ‹ÑÐ¾Ñ‚Ð° Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð³Ð¾ ÑÐ»Ð¾Ñ H0
        H0 = (4 / 3) * s
        st.write(f"**2. Ð’Ñ‹ÑÐ¾Ñ‚Ð° Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð³Ð¾ ÑÐ»Ð¾Ñ Ð³Ñ€ÑƒÐ½Ñ‚Ð°, Hâ‚€:** {H0:.2f} Ð¼")

        # 2. Ð Ð°Ð´Ð¸ÑƒÑ Ð²Ð»Ð¸ÑÐ½Ð¸Ñ R
        R = 1.95 * s * np.sqrt(k * H0)
        st.write(f"**4. Ð Ð°ÑÑ‡Ñ‘Ñ‚Ð½Ñ‹Ð¹ Ñ€Ð°Ð´Ð¸ÑƒÑ Ð²Ð»Ð¸ÑÐ½Ð¸Ñ, R:** {R:.2f} Ð¼")

        # 3. ÐšÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚ Î· Ð¿Ð¾ B/L
        ratio = B / L
        eta = 1.18  # Ð¿Ñ€Ð¸ B/L >= 0.6
        if ratio < 0.6:
            eta_values = {0.0: 1.00, 0.2: 1.12, 0.4: 1.16, 0.6: 1.18}
            eta = np.interp(ratio, list(eta_values.keys()), list(eta_values.values()))

        # 4. ÐŸÑ€Ð¸Ð²ÐµÐ´Ñ‘Ð½Ð½Ñ‹Ð¹ Ñ€Ð°Ð´Ð¸ÑƒÑ r0
        r0 = 0.25 * eta * (L + B)
        st.write(f"**5. ÐŸÑ€Ð¸Ð²ÐµÐ´Ñ‘Ð½Ð½Ñ‹Ð¹ Ñ€Ð°Ð´Ð¸ÑƒÑ ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½Ð°, râ‚€:** {r0:.2f} Ð¼ (Î· = {eta})")

        # 5. h0
        h0 = H0 - s
        st.write(f"**6. ÐžÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð² Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð·Ð¾Ð½Ðµ, hâ‚€:** {h0:.2f} Ð¼")

        # 6. ÐŸÑ€Ð¸Ñ‚Ð¾Ðº Q
        numerator = 1.36 * k * (H0**2 - h0**2)
        denominator = np.log10(R + r0) - np.log10(r0)
        Q = numerator / denominator
        Q_m3h = Q / 24

        st.write(f"**7. ÐŸÑ€Ð¸Ñ‚Ð¾Ðº Ð²Ð¾Ð´Ñ‹ Ð² ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½, Q:** **{Q:.2f} Ð¼Â³/ÑÑƒÑ‚** ({Q_m3h:.2f} Ð¼Â³/Ñ‡)")

        calc_data.update({
            "type": "ÐÐµÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¹",
            "steps": [
                f"Ð Ð°Ð·Ð¼ÐµÑ€Ñ‹: {L:.2f} Ð¼ Ã— {B:.2f} Ð¼, Ð³Ð»ÑƒÐ±Ð¸Ð½Ð°: {depth:.2f} Ð¼",
                f"Ð“Ñ€ÑƒÐ½Ñ‚: ÐŸÐµÑÐ¾Ðº, Ð£Ð“Ð’ Ð½Ð° {z_water_depth:.2f} Ð¼ Ð½Ð¸Ð¶Ðµ Ð¿Ð¾Ð²ÐµÑ€Ñ…Ð½Ð¾ÑÑ‚Ð¸",
                f"ÐšÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½ Ð½ÐµÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¹ â€” Ð´Ð½Ð¾ Ð½Ðµ Ð´Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚ Ð´Ð¾ Ð²Ð¾Ð´Ð¾ÑƒÐ¿Ð¾Ñ€Ð°",
                f"ÐšÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ k = {k:.2f} Ð¼/ÑÑƒÑ‚",
                f"ÐÐ¾Ð²Ñ‹Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð£Ð“Ð’ â€” Ð½Ð° {reserve:.2f} Ð¼ Ð½Ð¸Ð¶Ðµ Ð´Ð½Ð° ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½Ð°",
                f"Ð“Ð»ÑƒÐ±Ð¸Ð½Ð° Ð¿Ð¾Ð½Ð¸Ð¶ÐµÐ½Ð¸Ñ s = {depth:.2f} + {reserve:.2f} â€“ {z_water_depth:.2f} = {s:.2f} Ð¼",
                f"Ð’Ñ‹ÑÐ¾Ñ‚Ð° Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð³Ð¾ ÑÐ»Ð¾Ñ Hâ‚€ = 4/3 Ã— {s:.2f} = {H0:.2f} Ð¼",
                f"Ð Ð°Ð´Ð¸ÑƒÑ Ð²Ð»Ð¸ÑÐ½Ð¸Ñ R = 1.95 Ã— {s:.2f} Ã— âˆš({k:.2f} Ã— {H0:.2f}) = {R:.2f} Ð¼",
                f"ÐŸÑ€Ð¸Ð²ÐµÐ´Ñ‘Ð½Ð½Ñ‹Ð¹ Ñ€Ð°Ð´Ð¸ÑƒÑ râ‚€ = 0.25 Ã— {eta:.2f} Ã— ({L:.2f} + {B:.2f}) = {r0:.2f} Ð¼",
                f"ÐžÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ hâ‚€ = {H0:.2f} â€“ {s:.2f} = {h0:.2f} Ð¼",
                f"ÐŸÑ€Ð¸Ñ‚Ð¾Ðº Q = 1.36 Ã— {k:.2f} Ã— ({H0:.2f}Â² â€“ {h0:.2f}Â²) / (lg({R:.2f} + {r0:.2f}) â€“ lg({r0:.2f})) = {Q:.2f} Ð¼Â³/ÑÑƒÑ‚"
            ],
            "Q": Q,
            "Q_m3h": Q_m3h,
            "reserve_flow": Q_m3h * 1.3
        })

    # --- Ð Ð°ÑÑ‡ÐµÑ‚ Ð´Ð»Ñ Ð¡ÐžÐ’Ð•Ð Ð¨Ð•ÐÐÐžÐ“Ðž ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½Ð° (Ð¿Ð¾ Ð¡ÐŸ 103, ÑÑ…ÐµÐ¼Ð° 8) ---
    else:
        st.info("ðŸ”¹ ÐšÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½ ÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¹ â€” Ð´Ð½Ð¾ Ð´Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚ Ð´Ð¾ Ð²Ð¾Ð´Ð¾ÑƒÐ¿Ð¾Ñ€Ð½Ð¾Ð³Ð¾ ÑÐ»Ð¾Ñ")
        z_aquiclude = st.number_input("ÐžÑ‚Ð¼ÐµÑ‚ÐºÐ° Ð²Ð¾Ð´Ð¾ÑƒÐ¿Ð¾Ñ€Ð°, Ð¼", value=-5.0)

        H = abs(z_water) - z_aquiclude  # Ð¼Ð¾Ñ‰Ð½Ð¾ÑÑ‚ÑŒ Ð²Ð¾Ð´Ð¾Ð½Ð¾ÑÐ½Ð¾Ð³Ð¾ Ð¿Ð»Ð°ÑÑ‚Ð°
        h = H - s  # ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾Ð½Ð¸Ð¶ÐµÐ½Ð¸Ñ

        # Ð Ð°Ð´Ð¸ÑƒÑ Ð²Ð»Ð¸ÑÐ½Ð¸Ñ Ð¿Ð¾ Ð—Ð¸Ñ…Ð°Ñ€Ð´Ñ‚Ð° (Ñ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸ÐµÐ¼)
        R_raw = 3000 * s * np.sqrt(k)
        R = min(R_raw, 500)
        st.write(f"**Ð Ð°Ð´Ð¸ÑƒÑ Ð²Ð»Ð¸ÑÐ½Ð¸Ñ R:** {R:.2f} Ð¼ (Ñ€Ð°ÑÑ‡Ñ‘Ñ‚Ð½Ñ‹Ð¹: {R_raw:.2f} Ð¼)")

        # ÐŸÑ€Ð¸Ð²ÐµÐ´Ñ‘Ð½Ð½Ñ‹Ð¹ Ñ€Ð°Ð´Ð¸ÑƒÑ
        A = L * B
        r0 = np.sqrt(A / np.pi)
        st.write(f"**ÐŸÑ€Ð¸Ð²ÐµÐ´Ñ‘Ð½Ð½Ñ‹Ð¹ Ñ€Ð°Ð´Ð¸ÑƒÑ râ‚€:** {r0:.2f} Ð¼")

        # ÐŸÑ€Ð¸Ñ‚Ð¾Ðº (Ð¡Ñ…ÐµÐ¼Ð° 8, Ð¡ÐŸ 103)
        Q = (np.pi * k * (H**2 - h**2)) / np.log(R / r0)
        Q_m3h = Q / 24

        st.write(f"**ÐœÐ¾Ñ‰Ð½Ð¾ÑÑ‚ÑŒ Ð²Ð¾Ð´Ð¾Ð½Ð¾ÑÐ½Ð¾Ð³Ð¾ Ð¿Ð»Ð°ÑÑ‚Ð° H:** {H:.2f} Ð¼")
        st.write(f"**ÐŸÑ€Ð¸Ñ‚Ð¾Ðº Ð²Ð¾Ð´Ñ‹ Q:** **{Q:.2f} Ð¼Â³/ÑÑƒÑ‚** ({Q_m3h:.2f} Ð¼Â³/Ñ‡)")

        calc_data.update({
            "type": "Ð¡Ð¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¹",
            "steps": [
                f"Ð Ð°Ð·Ð¼ÐµÑ€Ñ‹: {L:.2f} Ð¼ Ã— {B:.2f} Ð¼, Ð³Ð»ÑƒÐ±Ð¸Ð½Ð°: {depth:.2f} Ð¼",
                f"Ð“Ñ€ÑƒÐ½Ñ‚: ÐŸÐµÑÐ¾Ðº, Ð£Ð“Ð’ Ð½Ð° {z_water_depth:.2f} Ð¼ Ð½Ð¸Ð¶Ðµ Ð¿Ð¾Ð²ÐµÑ€Ñ…Ð½Ð¾ÑÑ‚Ð¸",
                f"ÐšÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½ ÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¹ â€” Ð´Ð½Ð¾ Ð´Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚ Ð´Ð¾ Ð²Ð¾Ð´Ð¾ÑƒÐ¿Ð¾Ñ€Ð° ({z_aquiclude:.2f} Ð¼)",
                f"ÐšÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ k = {k:.2f} Ð¼/ÑÑƒÑ‚",
                f"Ð“Ð»ÑƒÐ±Ð¸Ð½Ð° Ð¿Ð¾Ð½Ð¸Ð¶ÐµÐ½Ð¸Ñ s = {s:.2f} Ð¼",
                f"ÐœÐ¾Ñ‰Ð½Ð¾ÑÑ‚ÑŒ Ð²Ð¾Ð´Ð¾Ð½Ð¾ÑÐ½Ð¾Ð³Ð¾ Ð¿Ð»Ð°ÑÑ‚Ð° H = {abs(z_water):.2f} â€“ ({z_aquiclude:.2f}) = {H:.2f} Ð¼",
                f"Ð Ð°Ð´Ð¸ÑƒÑ Ð²Ð»Ð¸ÑÐ½Ð¸Ñ R = 3000 Ã— {s:.2f} Ã— âˆš{k:.2f} = {R_raw:.2f} Ð¼ â†’ Ð¿Ñ€Ð¸Ð½ÑÑ‚ {R:.2f} Ð¼",
                f"ÐŸÑ€Ð¸Ð²ÐµÐ´Ñ‘Ð½Ð½Ñ‹Ð¹ Ñ€Ð°Ð´Ð¸ÑƒÑ râ‚€ = âˆš({A:.2f}/Ï€) = {r0:.2f} Ð¼",
                f"ÐŸÑ€Ð¸Ñ‚Ð¾Ðº Q = Ï€ Ã— {k:.2f} Ã— ({H:.2f}Â² â€“ {h:.2f}Â²) / ln({R:.2f}/{r0:.2f}) = {Q:.2f} Ð¼Â³/ÑÑƒÑ‚"
            ],
            "Q": Q,
            "Q_m3h": Q_m3h,
            "reserve_flow": Q_m3h * 1.3
        })

    # --- ÐŸÐ¾Ð´Ð±Ð¾Ñ€ Ð½Ð°ÑÐ¾ÑÐ° ---
    st.write("---")
    st.subheader("ðŸ› ï¸ ÐŸÐ¾Ð´Ð±Ð¾Ñ€ Ð½Ð°ÑÐ¾ÑÐ°")
    required_flow = calc_data["Q_m3h"]
    reserved_flow = calc_data["reserve_flow"]
    st.write(f"ðŸ”¹ **Ð¢Ñ€ÐµÐ±ÑƒÐµÐ¼Ð°Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ:** {required_flow:.2f} Ð¼Â³/Ñ‡")
    st.write(f"ðŸ”¹ **Ð¡ Ð·Ð°Ð¿Ð°ÑÐ¾Ð¼ 1.3:** **{reserved_flow:.2f} Ð¼Â³/Ñ‡**")

    if reserved_flow < 6:
        st.success("âœ… ÐŸÐ¾Ð´Ð¾Ð¹Ð´Ñ‘Ñ‚ Ð¿ÐµÑ€ÐµÐ½Ð¾ÑÐ½Ð¾Ð¹ Ð´Ñ€ÐµÐ½Ð°Ð¶Ð½Ñ‹Ð¹ Ð½Ð°ÑÐ¾Ñ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ZUMFA Small D8)")
    else:
        st.warning("âš ï¸ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð±Ð¾Ð»ÐµÐµ Ð¼Ð¾Ñ‰Ð½Ñ‹Ð¹ Ð½Ð°ÑÐ¾Ñ Ð¸Ð»Ð¸ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÐµÐ´Ð¸Ð½Ð¸Ñ†")

with tab2:
    st.header("ðŸ“– ÐœÐµÑ‚Ð¾Ð´Ð¸ÐºÐ° Ñ€Ð°ÑÑ‡ÐµÑ‚Ð°")
    st.markdown("""
    ### ÐÐµÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¹ ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½ (Ð¿Ð¾ Ñ€Ð°ÑÑ‡ÐµÑ‚Ñƒ.pdf)
    1. **ÐŸÐ¾Ð½Ð¸Ð¶ÐµÐ½Ð¸Ðµ s** = Ð³Ð»ÑƒÐ±Ð¸Ð½Ð° ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½Ð° + Ð·Ð°Ð¿Ð°Ñ â€“ Ð³Ð»ÑƒÐ±Ð¸Ð½Ð° Ð£Ð“Ð’  
    2. **Hâ‚€** = 4/3 Ã— s  
    3. **R** = 1.95 Ã— s Ã— âˆš(k Ã— Hâ‚€)  
    4. **râ‚€** = 0.25 Ã— Î· Ã— (L + B), Ð³Ð´Ðµ Î· Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ B/L  
    5. **hâ‚€** = Hâ‚€ â€“ s  
    6. **Q** = 1.36 Ã— k Ã— (Hâ‚€Â² â€“ hâ‚€Â²) / (lg(R + râ‚€) â€“ lg râ‚€)  

    ### Ð¡Ð¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¹ ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½ (Ð¡ÐŸ 103.13330.2012, ÑÑ…ÐµÐ¼Ð° 8)
    - **Q** = Ï€k(HÂ² â€“ hÂ²) / ln(R / râ‚€)  
    - **R** = 3000 Ã— s Ã— âˆšk (Ð½Ðµ Ð±Ð¾Ð»ÐµÐµ 500 Ð¼)  
    - **râ‚€** = âˆš(A / Ï€)  

    ### ÐžÑ‚Ð¼ÐµÑ‚ÐºÐ¸
    - ÐŸÐ¾Ð²ÐµÑ€Ñ…Ð½Ð¾ÑÑ‚ÑŒ Ð·ÐµÐ¼Ð»Ð¸ = **0.00 Ð¼**  
    - Ð£Ð“Ð’ Ð½Ð° 1.1 Ð¼ Ð½Ð¸Ð¶Ðµ â†’ **-1.10 Ð¼**  
    - Ð”Ð½Ð¾ ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½Ð° Ð½Ð° 2.25 Ð¼ â†’ **-2.25 Ð¼**  
    """)

with tab3:
    st.header("ðŸ“¥ Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð² Word â€” ÐºÐ°Ðº Ð² Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ðµ 'Ñ€Ð°ÑÑ‡ÐµÑ‚.pdf'")

    if not calc_data:
        st.warning("Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ñ€Ð°ÑÑ‡ÐµÑ‚ Ð½Ð° Ð²ÐºÐ»Ð°Ð´ÐºÐµ 'Ð Ð°ÑÑ‡ÐµÑ‚'.")
    else:
        if st.button("ðŸ“„ Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚ (Ð¿Ð¾ Ð¾Ð±Ñ€Ð°Ð·Ñ†Ñƒ)"):
            doc = Document()

            # --- Ð¡Ñ‚Ð¸Ð»ÑŒ ---
            style = doc.styles['Normal']
            style.font.name = 'Times New Roman'
            style.font.size = Pt(12)

            # --- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº ---
            title = doc.add_heading('Ð Ð°ÑÑ‡ÐµÑ‚ Ð¿Ñ€Ð¸Ñ‚Ð¾ÐºÐ° Ð³Ñ€ÑƒÐ½Ñ‚Ð¾Ð²Ñ‹Ñ… Ð²Ð¾Ð´', 0)
            title.alignment = WD_ALIGN_PARAGRAPH.CENTER

            # --- 1. ÐšÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½ ---
            doc.add_heading('1. ÐšÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½', level=1)
            doc.add_paragraph(f"Ð Ð°Ð·Ð¼ÐµÑ€Ñ‹: {L:.2f} Ð¼ Ã— {B:.2f} Ð¼")
            doc.add_paragraph(f"Ð“Ð»ÑƒÐ±Ð¸Ð½Ð°: {depth:.2f} Ð¼")
            doc.add_paragraph(f"Ð“Ñ€ÑƒÐ½Ñ‚: ÐŸÐµÑÐ¾Ðº, Ð³Ñ€ÑƒÐ½Ñ‚Ð¾Ð²Ñ‹Ðµ Ð²Ð¾Ð´Ñ‹ Ñ€Ð°ÑÐ¿Ð¾Ð»Ð°Ð³Ð°ÑŽÑ‚ÑÑ Ð½Ð° {z_water_depth:.2f} Ð¼ÐµÑ‚Ñ€Ð¾Ð² Ð½Ð¸Ð¶Ðµ Ð¿Ð¾Ð²ÐµÑ€Ñ…Ð½Ð¾ÑÑ‚Ð¸")
            doc.add_paragraph(f"ÐšÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½ {calc_data['type'].lower()}, Ñ‚Ð°Ðº ÐºÐ°Ðº ÐµÐ³Ð¾ Ð´Ð½Ð¾ Ð½Ðµ Ð´Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚ Ð´Ð¾ Ð²Ð¾Ð´Ð¾ÑƒÐ¿Ð¾Ñ€Ð½Ð¾Ð³Ð¾ ÑÐ»Ð¾Ñ")

            # --- ÐŸÐ¾ÑˆÐ°Ð³Ð¾Ð²Ñ‹Ð¹ Ñ€Ð°ÑÑ‡ÐµÑ‚ ---
            doc.add_heading(f"{calc_data['type'].capitalize()} ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½", level=1)
            for i, step in enumerate(calc_data["steps"], 1):
                p = doc.add_paragraph(step, style='List Number')

            # --- Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¸Ñ‚Ð¾Ðº ---
            doc.add_paragraph(f"ÐŸÑ€Ð¸Ñ‚Ð¾Ðº Ð²Ð¾Ð´Ñ‹ Ð² ÐºÐ¾Ñ‚Ð»Ð¾Ð²Ð°Ð½ Q = {calc_data['Q']:.2f} Ð¼Â³/ÑÑƒÑ‚ Ð¸Ð»Ð¸ Ð¾ÐºÐ¾Ð»Ð¾ {calc_data['Q_m3h']:.2f} Ð¼Â³/Ñ‡.")

            # --- ÐŸÐ¾Ð´Ð±Ð¾Ñ€ Ð½Ð°ÑÐ¾ÑÐ° ---
            doc.add_paragraph(f"ÐŸÐµÑ€ÐµÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ñ ÐºÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð¼ Ð·Ð°Ð¿Ð°ÑÐ°: {calc_data['Q_m3h']:.2f} Ã— 1.3 = {calc_data['reserve_flow']:.2f} Ð¼Â³/Ñ‡")

            # --- Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ ---
            if calc_data['reserve_flow'] < 6:
                doc.add_paragraph("")
            else:
                doc.add_paragraph(f"Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð½Ð°ÑÐ¾Ñ Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒÑŽ Ð½Ðµ Ð¼ÐµÐ½ÐµÐµ {calc_data['reserve_flow']:.2f} Ð¼Â³/Ñ‡.")

            # --- Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ---
            buffer = io.BytesIO()
            doc.save(buffer)
            buffer.seek(0)

            st.download_button(
                label="â¬‡ï¸ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚ (Word .docx)",
                data=buffer,
                file_name="Ð Ð°ÑÑ‡ÐµÑ‚_Ð¿Ñ€Ð¸Ñ‚Ð¾ÐºÐ°_Ð²Ð¾Ð´Ñ‹_Ð¿Ð¾_Ð¾Ð±Ñ€Ð°Ð·Ñ†Ñƒ.docx",
                mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            )
            st.success("âœ… ÐžÑ‚Ñ‡ÐµÑ‚ ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð² Ñ‚Ð¾Ñ‡Ð½Ð¾Ð¼ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ñ Ð¾Ð±Ñ€Ð°Ð·Ñ†Ð¾Ð¼!")

# --- Ð—Ð°Ð¿ÑƒÑÐº: streamlit run app.py